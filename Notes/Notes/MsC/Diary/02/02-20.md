Another day another slay

I'm trying to rescale the coordinates from the csv

This is how it looks like without rescaling positions

![[Pasted image 20260220102632.png]]

So after processing the image, the positions are misaligned.

But after scaling with the same factor for positions
![[Pasted image 20260220102751.png]]

It looks aligned

The same for the mask
![[Pasted image 20260220102919.png]]

when forming the scaling factor:
```
before = raw.shape[0]
raw = process(raw)
scale = before/raw.shape[0]
```
Gives more decimals than
`scale = mpp/dct_config.STANDARD_MPP_RESOLUTION`

Padding shifts the image as well

All ROI images tested can be found in out/position_scaling

Now i just need to figure out how to get only the cell boundaries and not every single detection

New annoying bug, the positions fix led to zero batches in the embedding part...

I think it may be due to the super small detections.

Yes, i was right. When i excluded the super small detections in qupath

Examples of how it gets misaligned:

Good
![[Pasted image 20260220140554.png]]

Bad
![[Pasted image 20260220141208.png]]

```
        import matplotlib.pyplot as plt
        plt.imshow(self_mask[:,:])
        plt.scatter(delta,delta)
        plt.show()

```

Oh my god i solved it, it is because numpy matrixes uses matrix(row, column), so row is y and column is x, and therefore im not supposed to extract values using matrix(x,y) but matrix(y,x)

Another problem, WHY ARE MY CELLS DISAPPEARING?
I have 7076 in mask and csv, both are correct, but after preprocessing, it only processes 6948 of them, 128 are missing!

Its because some detections are super small, and the rounding of coordinates leads to the index being extracted outside of the cell

![[Pasted image 20260220162414.png]]![[Pasted image 20260220162427.png]]

Suggestion: if the idx returns zero, remove the position from the array

I will have to export a new csv based on these removed cells.